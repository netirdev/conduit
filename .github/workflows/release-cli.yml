name: CLI Release

on:
  push:
    tags: ["release-cli-*"]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number for experimental release (leave empty for regular release)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/conduit

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./cli
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR branch if experimental release
        if: inputs.pr_number != ''
        working-directory: .
        run: gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go 1.24.3
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.3"

      - name: Verify Go version
        run: go version

      - name: Setup dependencies
        run: make setup

      - name: Run tests
        run: make test

  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./cli
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR branch if experimental release
        if: inputs.pr_number != ''
        working-directory: .
        run: gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Go 1.24.3
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.3"

      - name: Verify Go version
        run: go version

      - name: Setup dependencies
        run: make setup

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.5

      - name: Run lint
        run: make lint

  build:
    runs-on: ubuntu-latest
    needs: [test, lint]
    permissions:
      contents: write
      packages: write
    defaults:
      run:
        working-directory: ./cli
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR branch if experimental release
        if: inputs.pr_number != ''
        working-directory: .
        run: gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set version
        id: version
        run: |
          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "VERSION=experimental-pr${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=experimental-pr${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "IS_EXPERIMENTAL=true" >> $GITHUB_OUTPUT
          elif [ -n "$GITHUB_REF_NAME" ] && [[ "$GITHUB_REF_NAME" == release-cli-* ]]; then
            echo "VERSION=${GITHUB_REF_NAME#release-cli-}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
            echo "IS_EXPERIMENTAL=false" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "IS_EXPERIMENTAL=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Go 1.24.3
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.3"

      - name: Verify Go version
        run: go version

      - name: Setup dependencies
        run: make setup

      - name: Create Psiphon config
        run: printf '%s' "$PSIPHON_CONFIG_JSON" > psiphon_config.json
        env:
          PSIPHON_CONFIG_JSON: ${{ secrets.PSIPHON_CONFIG_JSON }}

      - name: Build all platforms with embedded config
        run: make build-all-embedded PSIPHON_CONFIG=psiphon_config.json VERSION=${{ steps.version.outputs.VERSION }}

      - name: Remove Psiphon config from dist
        run: rm -f psiphon_config.json internal/config/psiphon_config.json

      - name: Create checksums
        run: |
          cd dist
          sha256sum conduit-* > checksums.txt
          cat checksums.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cli-dist
          path: |
            cli/dist/conduit-linux-amd64
            cli/dist/conduit-linux-arm64
            cli/dist/conduit-linux-arm
            cli/dist/conduit-darwin-amd64
            cli/dist/conduit-darwin-arm64
            cli/dist/conduit-windows-amd64.exe
            cli/dist/conduit-freebsd-amd64
            cli/dist/checksums.txt

      - name: Delete existing experimental release if it exists
        if: inputs.pr_number != ''
        continue-on-error: true
        working-directory: .
        run: gh release delete ${{ steps.version.outputs.VERSION }} --yes --cleanup-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: ${{ steps.version.outputs.IS_EXPERIMENTAL == 'true' && format('Conduit CLI {0} (Experimental)', steps.version.outputs.VERSION) || format('Conduit CLI {0}', steps.version.outputs.VERSION) }}
          draft: ${{ steps.version.outputs.IS_EXPERIMENTAL == 'false' }}
          prerelease: ${{ steps.version.outputs.IS_EXPERIMENTAL == 'true' }}
          make_latest: ${{ steps.version.outputs.IS_EXPERIMENTAL == 'false' }}
          files: |
            cli/dist/conduit-linux-amd64
            cli/dist/conduit-linux-arm64
            cli/dist/conduit-linux-arm
            cli/dist/conduit-darwin-amd64
            cli/dist/conduit-darwin-arm64
            cli/dist/conduit-windows-amd64.exe
            cli/dist/conduit-freebsd-amd64
            cli/dist/checksums.txt
          body: |
            ## ${{ steps.version.outputs.IS_EXPERIMENTAL == 'true' && '⚠️ Experimental Release' || format('Conduit CLI {0}', steps.version.outputs.VERSION) }}

            ${{ steps.version.outputs.IS_EXPERIMENTAL == 'true' && format('This is an experimental release built from PR #{0}. **Warning:** This build is for testing purposes only.', inputs.pr_number) || 'Conduit is a volunteer-run proxy node that helps relay traffic for users in censored regions.' }}

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x86_64 (amd64) | [conduit-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-linux-amd64) |
            | Linux | ARM64 | [conduit-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-linux-arm64) |
            | Linux | ARMv7 (32-bit) | [conduit-linux-arm](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-linux-arm) |
            | macOS | Intel (amd64) | [conduit-darwin-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-darwin-amd64) |
            | macOS | Apple Silicon (arm64) | [conduit-darwin-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-darwin-arm64) |
            | Windows | x86_64 (amd64) | [conduit-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-windows-amd64.exe) |
            | FreeBSD | x86_64 (amd64) | [conduit-freebsd-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-freebsd-amd64) |

            ### Quick Start

            ```bash
            # Download (Linux x86_64 example)
            curl -L -o conduit https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/conduit-linux-amd64
            chmod +x conduit

            # Run
            ./conduit start

            # Run with verbose output
            ./conduit start -v
            ```

            ### Docker

            Two image variants are available:
            - **`:latest`** / **`:${{ steps.version.outputs.VERSION }}`** - Debian-based
            - **`:distroless`** / **`:${{ steps.version.outputs.VERSION }}-distroless`** - Distroless (smaller, minimal attack surface)

            ```bash
            # Debian variant
            docker pull ghcr.io/${{ github.repository }}/conduit:${{ steps.version.outputs.VERSION }}
            docker run -d --name conduit \
              -v conduit-data:/home/conduit/data \
              --restart unless-stopped \
              ghcr.io/${{ github.repository }}/conduit:${{ steps.version.outputs.VERSION }}

            # Distroless variant (smaller, more secure)
            docker pull ghcr.io/${{ github.repository }}/conduit:${{ steps.version.outputs.VERSION }}-distroless
            docker run -d --name conduit \
              -v conduit-data:/data \
              --restart unless-stopped \
              ghcr.io/${{ github.repository }}/conduit:${{ steps.version.outputs.VERSION }}-distroless
            ```

            **Important:** Always use a persistent volume for the data directory.

            ### Verify Downloads

            ```bash
            curl -L -o checksums.txt https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.TAG_NAME }}/checksums.txt
            sha256sum -c checksums.txt --ignore-missing
            ```

  docker:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch PR branch if experimental release
        if: inputs.pr_number != ''
        run: gh pr checkout ${{ inputs.pr_number }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: cli-dist
          path: cli/dist

      - name: Set version
        id: version
        run: |
          if [ -n "${{ inputs.pr_number }}" ]; then
            echo "VERSION=experimental-pr${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
            echo "IS_EXPERIMENTAL=true" >> $GITHUB_OUTPUT
          elif [ -n "$GITHUB_REF_NAME" ] && [[ "$GITHUB_REF_NAME" == release-cli-* ]]; then
            echo "VERSION=${GITHUB_REF_NAME#release-cli-}" >> $GITHUB_OUTPUT
            echo "IS_EXPERIMENTAL=false" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
            echo "IS_EXPERIMENTAL=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image (Debian)
        uses: docker/build-push-action@v5
        with:
          context: ./cli
          file: ./cli/Dockerfile
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
            ${{ steps.version.outputs.IS_EXPERIMENTAL == 'false' && format('{0}/{1}:latest', env.REGISTRY, env.IMAGE_NAME) || '' }}

      - name: Build and push Docker image (Distroless)
        uses: docker/build-push-action@v5
        with:
          context: ./cli
          file: ./cli/Dockerfile.distroless
          platforms: linux/amd64,linux/arm64,linux/arm/v7
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}-distroless
            ${{ steps.version.outputs.IS_EXPERIMENTAL == 'false' && format('{0}/{1}:distroless', env.REGISTRY, env.IMAGE_NAME) || '' }}
